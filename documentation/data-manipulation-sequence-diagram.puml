@startuml Data_Manipulation_Sequence_Diagram
!theme aws-orange
title Data Research Analysis Platform - Data Manipulation Workflow

participant "User" as User
participant "CustomDataTable\n(Component)" as Table
participant "Excel.vue\n(Parent)" as Excel
participant "PDF.vue\n(Parent)" as PDF
participant "Sheet State\n(Reactive)" as State
participant "Browser\n(Event System)" as Browser

== Row Addition Workflow ==

User -> Table: Click "Add Row" or\nKeyboard Shortcut (Ctrl+Alt+R)
activate Table

Table -> Table: addNewRow(position, defaultData)
Table -> Table: Generate unique row ID
Table -> Table: Initialize with default values for all columns
Table -> Table: updateRowIndices()

Table -> State: Update tableState.rows
Table -> Table: Update multi-sheet mode if active
Table -> Table: emit('row-added', {\n  rowId, rowData, position,\n  allRows, rowCount\n})

Table -> Excel: @row-added event
activate Excel
Excel -> Excel: handleRowAdded(event)
Excel -> Excel: Find activeSheet by ID
Excel -> Excel: activeSheet.rows = [...event.allRows]
Excel -> Excel: Update metadata (rowCount, modified)
Excel -> Excel: Console log for debugging
deactivate Excel

Table -> Table: showSelectionFeedback("New row added")
deactivate Table

== Column Addition Workflow ==

User -> Table: Click "Add Column" or\nKeyboard Shortcut (Ctrl+Alt+C)
activate Table

Table -> Table: addNewColumn(position, columnConfig)
Table -> Table: Generate unique column ID
Table -> Table: Create column structure with defaults

Table -> Table: Add default values to existing rows
loop For each existing row
    Table -> Table: row.data[newColumn.key] = defaultValue
end

Table -> State: Update tableState.columns
Table -> Table: Update multi-sheet mode if active
Table -> Table: emit('column-added', {\n  columnId, columnData, position,\n  allColumns, columnCount\n})

Table -> Excel: @column-added event
activate Excel
Excel -> Excel: handleColumnAdded(event)
Excel -> Excel: Find activeSheet by ID
Excel -> Excel: activeSheet.columns = [...event.allColumns]
Excel -> Excel: Update metadata (columnCount, modified)
Excel -> Excel: Console log for debugging
deactivate Excel

Table -> Table: showSelectionFeedback("New column added")
deactivate Table

== Cell Update After Addition ==

User -> Table: Click on cell and type value
activate Table

Table -> Table: startEditing(rowId, columnKey)
Table -> Table: Show input field

User -> Table: Enter new value and press Enter
Table -> Table: updateCellValue(rowId, columnKey, newValue)
Table -> Table: Type conversion based on column type
Table -> Table: row.data[columnKey] = processedValue

Table -> Table: emit('cell-updated', {\n  rowId, columnKey,\n  oldValue, newValue, row\n})

Table -> Excel: @cell-updated event
activate Excel
Excel -> Excel: handleCellUpdate(event)
Excel -> Excel: Find activeSheet by ID
Excel -> Excel: Find row by event.rowId
Excel -> Excel: row.data[event.columnKey] = event.newValue
Excel -> Excel: Update activeSheet.metadata.modified
deactivate Excel

Table -> Table: stopEditing()
deactivate Table

== Row Duplication Workflow ==

User -> Table: Right-click row header → "Duplicate Row"
activate Table

Table -> Table: duplicateRow(rowId)
Table -> Table: Find source row by ID
Table -> Table: Generate new row ID
Table -> Table: Create duplicated row with copied data
Table -> Table: Insert after source row
Table -> Table: updateRowIndices()

Table -> Table: emit('row-duplicated', {\n  originalRowId, newRowId,\n  rowData, position, allRows\n})

Table -> Excel: @row-duplicated event (if handler exists)
Table -> Table: showSelectionFeedback("Row duplicated")
deactivate Table

== Context Menu Operations ==

User -> Table: Right-click row number
Table -> Browser: Show context menu
Browser -> Table: Position menu relative to click

User -> Table: Select "Insert Row Above"
Table -> Table: insertRowAt(showRowMenu)
Table -> Table: Follow Row Addition Workflow

User -> Table: Select "Insert Row Below"  
Table -> Table: insertRowAt(showRowMenu + 1)
Table -> Table: Follow Row Addition Workflow

== Keyboard Shortcuts ==

User -> Browser: Press Ctrl+Alt+R
Browser -> Table: handleKeyboardShortcuts(event)
Table -> Table: addNewRow() → Follow Row Addition Workflow

User -> Browser: Press Ctrl+Alt+C
Browser -> Table: handleKeyboardShortcuts(event) 
Table -> Table: addNewColumn() → Follow Column Addition Workflow

User -> Browser: Press Ctrl+D (with row selected)
Browser -> Table: handleKeyboardShortcuts(event)
Table -> Table: duplicateRow(selectedRowId) → Follow Duplication Workflow

== Error Handling ==

alt Row not found during cell update
    Table -> Excel: @cell-updated event
    Excel -> Excel: handleCellUpdate(event)
    Excel -> Excel: activeSheet.rows.find(row => row.id === event.rowId)
    Excel -> Excel: Row not found - log error
    Excel -> Browser: console.error("Row not found for event")
end

== Data Model Creation Workflow ==

participant "Frontend" as Frontend
participant "DataSourceProcessor" as DSProcessor
participant "Database (PostgreSQL)" as DB
participant "External DataSource" as ExtDB

User -> Frontend: Select data source and write SQL query
Frontend -> Frontend: Build query in visual editor
Frontend -> Frontend: Configure data model name and schema

User -> Frontend: Click "Create Data Model"
Frontend -> DSProcessor: buildDataModelOnQuery(\n  dataSourceId,\n  query,\n  queryJSON,\n  dataModelName,\n  tokenDetails\n)
activate DSProcessor

DSProcessor -> DB: Get data source with connection_details
activate DB
DB -> DB: Decrypt connection_details
DB --> DSProcessor: Data source with credentials
deactivate DB

DSProcessor -> DSProcessor: Generate sanitized table name
note right: Format: dra_{sanitized_name}_{uuid}\nMax length: 63 characters

DSProcessor -> ExtDB: Connect to external database
activate ExtDB
DSProcessor -> ExtDB: Execute user's SQL query
ExtDB --> DSProcessor: Query results (sample data)
deactivate ExtDB

DSProcessor -> DSProcessor: Analyze result columns and data types
DSProcessor -> DSProcessor: Generate CREATE TABLE statement
note right: Column types mapped:\nString → VARCHAR\nNumber → NUMERIC\nDate → TIMESTAMP

DSProcessor -> DB: CREATE TABLE schema.table_name (columns...)
activate DB
DB --> DSProcessor: Table created
deactivate DB

DSProcessor -> DB: INSERT INTO table_name SELECT * FROM external_query
note right: Populate table with data
activate DB
DB --> DSProcessor: Data inserted
deactivate DB

DSProcessor -> DB: Create DRADataModel entity
activate DB
DB --> DSProcessor: Data model saved
deactivate DB

DSProcessor --> Frontend: Success with table name
deactivate DSProcessor

Frontend -> Frontend: Navigate to data models page
Frontend -> Frontend: Show success message

== Data Model Deletion Workflow ==

User -> Frontend: Click delete icon on data model
Frontend -> Frontend: Show confirmation dialog

User -> Frontend: Confirm deletion
Frontend -> DSProcessor: DataModelProcessor.deleteDataModel(\n  dataModelId,\n  tokenDetails\n)
activate DSProcessor

DSProcessor -> DB: Find data model by ID
activate DB
DB --> DSProcessor: Data model with schema and name
deactivate DB

DSProcessor -> DSProcessor: Begin transaction

DSProcessor -> DB: DROP TABLE IF EXISTS schema.table_name CASCADE
note right: Physical table removal
activate DB
DB --> DSProcessor: Table dropped
deactivate DB

DSProcessor -> DB: Check for dashboards using this data model
activate DB
DB --> DSProcessor: Dashboard list
deactivate DB

loop For each dashboard
    DSProcessor -> DSProcessor: Remove data model references from dashboard.data
    DSProcessor -> DB: UPDATE dashboard SET data = modified_data
    DB --> DSProcessor: Dashboard updated
end

DSProcessor -> DB: DELETE FROM dra_data_models WHERE id = ?
activate DB
DB --> DSProcessor: Data model deleted
deactivate DB

DSProcessor -> DSProcessor: Commit transaction

DSProcessor --> Frontend: Success
deactivate DSProcessor

Frontend -> Frontend: Remove from local data models list
Frontend -> Frontend: Show success message

== Dashboard Chart Creation Workflow ==

User -> Frontend: Open dashboard editor
Frontend -> Frontend: Load available data models

User -> Frontend: Drag chart widget onto canvas
Frontend -> Frontend: Open chart configuration dialog

User -> Frontend: Select data model and columns
User -> Frontend: Choose chart type (bar, line, pie, etc.)
User -> Frontend: Configure chart options

Frontend -> Frontend: Build chart configuration object
note right: Structure:\n{\n  type: 'bar',\n  dataModelId: 123,\n  columns: [...],\n  options: {...}\n}

User -> Frontend: Click "Save Dashboard"
Frontend -> DSProcessor: DashboardProcessor.addDashboard(\n  dashboardData,\n  projectId,\n  tokenDetails\n)
activate DSProcessor

DSProcessor -> DB: Create DRADashboard entity
note right: data field is JSONB type\nStores entire dashboard configuration
activate DB

DB -> DB: Store as JSONB column
note right: Efficient querying and indexing\nNative JSON operations supported

DB --> DSProcessor: Dashboard saved
deactivate DB

DSProcessor --> Frontend: Success with dashboard ID
deactivate DSProcessor

Frontend -> Frontend: Navigate to dashboard view
Frontend -> Frontend: Render charts from configuration

== Dashboard Chart Rendering ==

Frontend -> Frontend: Parse dashboard.data JSONB
Frontend -> Frontend: Extract chart configurations

loop For each chart
    Frontend -> DSProcessor: Fetch data model data
    activate DSProcessor
    
    DSProcessor -> DB: SELECT * FROM schema.table_name
    activate DB
    DB --> DSProcessor: Table data
    deactivate DB
    
    DSProcessor --> Frontend: Data rows
    deactivate DSProcessor
    
    Frontend -> Frontend: Transform data for chart library
    Frontend -> Frontend: Render chart component
end

Frontend -> Frontend: Display complete dashboard

@enduml

alt Invalid column position
    Table -> Table: addNewColumn(invalidPosition)
    Table -> Table: Default to 'end' position
    Table -> Table: Continue with normal flow
end

@enduml
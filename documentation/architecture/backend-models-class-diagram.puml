@startuml Backend_Models_Class_Diagram
title Data Research Analysis Platform - Backend Models

' Define styling
skinparam class {
    BackgroundColor LightBlue
    BorderColor DarkBlue
    ArrowColor DarkBlue
}
skinparam package {
    BackgroundColor LightGray
    BorderColor Gray
}

package "Core Entities" {
    class DRAUser {
        +id: number
        +email: string
        +created_at: Date
    

    class DRAUsersPlatform {
        +id: number
        +email: string
        +first_name: string
        +last_name: string
        +password: string
        +user_type: EUserType
        +email_verified_at: Date
        +unsubscribe_from_emails_at: Date
        --
        +projects: DRAProject[]
        +data_sources: DRADataSource[]
        +data_models: DRADataModel[]
        +verification_codes: DRAVerificationCode[]
        +dashboards: DRADashboard[]
        +articles: DRAArticle[]
        +categories: DRACategory[]
    }

    class DRAVerificationCode {
        +id: number
        +code: string
        +expired_at: Date
        --
        +users_platform: DRAUsersPlatform
    }
}

package "Project Management" {
    class DRAProject {
        +id: number
        +name: string
        +description: string
        +created_at: Date
        --
        +users_platform: DRAUsersPlatform
        +data_sources: DRADataSource[] {cascade: remove, update}
        +dashboards: DRADashboard[] {cascade: remove, update}
    }
}

package "Data Layer" {
    class DRADataSource {
        +id: number
        +name: string
        +data_type: EDataSourceType
        +connection_details: IDBConnectionDetails <<encrypted>>
        +created_at: Date
        --
        +users_platform: DRAUsersPlatform
        +project: DRAProject {onDelete: CASCADE}
        +data_models: DRADataModel[] {cascade: remove, update}
    }

    class DRADataModel {
        +id: number
        +schema: string
        +name: string
        +sql_query: string
        +query: JSON
        --
        +users_platform: DRAUsersPlatform
        +data_source: DRADataSource {onDelete: CASCADE}
    }
}

package "Dashboard & Visualization" {
    class DRADashboard {
        +id: number
        +data: IDashboardDataStructure (JSONB)
        --
        +users_platform: DRAUsersPlatform
        +project: DRAProject {onDelete: CASCADE}
        +export_meta_data: DRADashboardExportMetaData[] {cascade: remove, update}
    }

    class DRADashboardExportMetaData {
        +id: number
        +dashboard_id: number
        +file_name: string
        +file_path: string
        +file_size: number
        +created_at: Date
        --
        +dashboard: DRADashboard {onDelete: CASCADE}
    }
}

package "Content Management" {
    class DRAArticle {
        +id: number
        +title: string
        +content: string
        +content_markdown?: string
        +publish_status: EPublishStatus
        +slug: string
        +created_at: Date
        --
        +users_platform: DRAUsersPlatform {onDelete: CASCADE}
        +dra_articles_categories: DRAArticleCategory[]
    }

    class DRACategory {
        +id: number
        +title: string
        --
        +users_platform: DRAUsersPlatform {onDelete: CASCADE}
        +dra_articles_categories: DRAArticleCategory[]
    }

    class DRAArticleCategory {
        +id: number
        +article_id: number
        +category_id: number
        --
        +article: DRAArticle
        +category: DRACategory
        +users_platform: DRAUsersPlatform
    }
    
    enum EPublishStatus {
        PUBLISHED
        DRAFT
    }
}

package "Project Collaboration" {
    class DRAProjectMember {
        +id: number
        +role: EProjectRole
        +joined_at: Date
        +invited_by: number?
        --
        +project: DRAProject {onDelete: CASCADE}
        +users_platform: DRAUsersPlatform
    }

    class DRAProjectInvitation {
        +id: number
        +email: string
        +role: EProjectRole
        +token: string
        +status: EInvitationStatus
        +expires_at: Date
        +accepted_at: Date?
        +reactivated_at: Date?
        --
        +project: DRAProject {onDelete: CASCADE}
        +invited_by: DRAUsersPlatform
    }

    enum EProjectRole {
        OWNER
        EDITOR
        VIEWER
    }

    enum EInvitationStatus {
        PENDING
        ACCEPTED
        CANCELLED
        EXPIRED
    }
}

package "Notifications" {
    class DRANotification {
        +id: number
        +type: string
        +title: string
        +message: string
        +is_read: boolean
        +read_at: Date?
        +expires_at: Date?
        +metadata: JSONB?
        +created_at: Date
        --
        +users_platform: DRAUsersPlatform {onDelete: CASCADE}
    }
}

package "Account Lifecycle" {
    class DRAAccountCancellation {
        +id: number
        +reason: string
        +category: string
        +feedback: string?
        +status: EAccountCancellationStatus
        +grace_period_ends_at: Date
        +requested_at: Date
        +reactivated_at: Date?
        --
        +users_platform: DRAUsersPlatform
    }

    enum EAccountCancellationStatus {
        PENDING
        CANCELLED
        DATA_DELETED
    }
}

package "Subscriptions" {
    class DRASubscriptionTier {
        +id: number
        +name: string
        +tier_key: string
        +max_projects: number
        +max_data_sources: number
        +max_total_rows: number
        +features: JSONB
        +is_active: boolean
    }

    class DRAUserSubscription {
        +id: number
        +tier: string
        +assigned_at: Date
        +assigned_by: number?
        --
        +users_platform: DRAUsersPlatform {onDelete: CASCADE}
    }

    class DRAEmailPreferences {
        +id: number
        +marketing_emails: boolean
        +product_updates: boolean
        +weekly_digest: boolean
        +created_at: Date
        +updated_at: Date
        --
        +users_platform: DRAUsersPlatform {onDelete: CASCADE}
    }
}

package "Data Infrastructure" {
    class DRAMongoDBSyncHistory {
        +id: number
        +sync_type: EMongoSyncType
        +status: string
        +records_synced: number
        +error_message: string?
        +started_at: Date
        +completed_at: Date?
        --
        +data_source: DRADataSource {onDelete: CASCADE}
    }

    class DRATableMetadata {
        +id: number
        +schema_name: string
        +table_name: string
        +column_metadata: JSONB
        +row_count: number?
        +last_analyzed_at: Date?
        --
        +data_source: DRADataSource {onDelete: CASCADE}
    }

    class DRADataModelSource {
        +id: number
        +alias: string
        +join_type: string?
        +join_condition: string?
        --
        +data_model: DRADataModel {onDelete: CASCADE}
        +data_source: DRADataSource
    }

    class DRADataModelRefreshHistory {
        +id: number
        +refresh_type: string
        +rows_affected: number?
        +duration_ms: number?
        +status: string
        +error_message: string?
        +refreshed_at: Date
        --
        +data_model: DRADataModel {onDelete: CASCADE}
    }

    class DRACrossSourceJoinCatalog {
        +id: number
        +join_name: string
        +left_schema: string
        +left_table: string
        +right_schema: string
        +right_table: string
        +join_conditions: JSONB
        +is_active: boolean
        --
        +project: DRAProject {onDelete: CASCADE}
    }

    enum EMongoSyncType {
        FULL
        INCREMENTAL
    }
}

package "AI / Intelligence" {
    class DRAAIDataModelConversation {
        +id: number
        +status: EConversationStatus
        +schema_context: text?
        +model_draft: JSONB?
        +created_at: Date
        +updated_at: Date
        --
        +users_platform: DRAUsersPlatform {onDelete: CASCADE}
        +data_source: DRADataSource {onDelete: CASCADE}
    }

    class DRAAIDataModelMessage {
        +id: number
        +role: EMessageRole
        +content: text
        +created_at: Date
        --
        +conversation: DRAAIDataModelConversation {onDelete: CASCADE}
    }

    class DRAAIInsightReport {
        +id: number
        +title: string
        +insight_type: string
        +results: JSONB
        +status: string
        +created_at: Date
        --
        +data_model: DRADataModel {onDelete: CASCADE}
        +users_platform: DRAUsersPlatform
    }

    class DRAAIInsightMessage {
        +id: number
        +role: EMessageRole
        +content: text
        +created_at: Date
        --
        +insight_report: DRAAIInsightReport {onDelete: CASCADE}
    }

    class DRAAIJoinSuggestion {
        +id: number
        +left_schema: string
        +left_table: string
        +right_schema: string
        +right_table: string
        +confidence_score: float
        +reasoning: text?
        +status: string
        --
        +project: DRAProject {onDelete: CASCADE}
    }

    enum EConversationStatus {
        DRAFT
        SAVED
        ARCHIVED
    }

    enum EMessageRole {
        USER
        ASSISTANT
    }
}

package "Administration" {
    class DRAScheduledBackupRun {
        +id: number
        +backup_type: string
        +status: string
        +filename: string?
        +file_size_bytes: number?
        +error_message: string?
        +initiated_at: Date
        +completed_at: Date?
        --
        +initiated_by: DRAUsersPlatform
    }

    class DRAPlatformSettings {
        +id: number
        +setting_key: string
        +setting_value: JSONB
        +description: string?
        +updated_at: Date
        --
        +updated_by: DRAUsersPlatform?
    }

    class DRASitemapEntry {
        +id: number
        +url: string
        +priority: float
        +change_frequency: string
        +last_modified: Date
    }
}

package "Content (existing + extended)" {
    class DRAArticleVersion {
        +id: number
        +content: text
        +content_markdown: text?
        +version_number: number
        +created_at: Date
        --
        +article: DRAArticle {onDelete: CASCADE}
        +created_by: DRAUsersPlatform
    }
}

' New Relationships
DRAProject ||--o{ DRAProjectMember : "has members"
DRAProject ||--o{ DRAProjectInvitation : "has invitations"
DRAUsersPlatform ||--o{ DRAProjectMember : "member of"
DRAUsersPlatform ||--o{ DRANotification : "receives"
DRAUsersPlatform ||--o{ DRAAccountCancellation : "requests"
DRAUsersPlatform ||--o| DRAUserSubscription : "subscribed via"
DRAUsersPlatform ||--o| DRAEmailPreferences : "preferences"
DRADataSource ||--o{ DRAMongoDBSyncHistory : "tracks syncs"
DRADataSource ||--o{ DRATableMetadata : "has metadata"
DRADataModel ||--o{ DRADataModelSource : "built from"
DRADataModel ||--o{ DRADataModelRefreshHistory : "refresh history"
DRAProject ||--o{ DRACrossSourceJoinCatalog : "defines joins"
DRAProject ||--o{ DRAAIJoinSuggestion : "AI suggestions"
DRAUsersPlatform ||--o{ DRAAIDataModelConversation : "has conversations"
DRADataSource ||--o{ DRAAIDataModelConversation : "context for"
DRAAIDataModelConversation ||--o{ DRAAIDataModelMessage : "contains"
DRADataModel ||--o{ DRAAIInsightReport : "analyzed by AI"
DRAAIInsightReport ||--o{ DRAAIInsightMessage : "conversation"
DRAArticle ||--o{ DRAArticleVersion : "versioned as"

note right of DRAProjectMember : RBAC-enforced project access\nRoles: OWNER > EDITOR > VIEWER\nControls all project operations

note right of DRANotification : Real-time delivery via Socket.IO\nPersisted for offline users\nAuto-expires after configurable TTL

note right of DRAAIDataModelConversation : Redis session (active)\nâ†’ PostgreSQL (on save via\ntransferToDatabase())\n24-hour Redis TTL

note right of DRAScheduledBackupRun : Tracks both manual +\nautomated backup runs\nLinks to BullMQ job ID
' Relationships
DRAUsersPlatform ||--o{ DRAProject : "owns"
DRAUsersPlatform ||--o{ DRADataSource : "creates"
DRAUsersPlatform ||--o{ DRADataModel : "builds"
DRAUsersPlatform ||--o{ DRAVerificationCode : "has"
DRAUsersPlatform ||--o{ DRADashboard : "creates"
DRAUsersPlatform ||--o{ DRAArticle : "authors"
DRAUsersPlatform ||--o{ DRACategory : "manages"

DRAProject ||--o{ DRADataSource : "contains"
DRAProject ||--o{ DRADashboard : "includes"

DRADataSource ||--o{ DRADataModel : "generates"



DRADashboard --|> DRADashboardExportMetaData : "exports to"
DRADataSource --|> EDataSourceType : "typed as"
DRADataSource --|> IDBConnectionDetails : "configured with"
DRAArticle --|> DRACategory : "categorized by"
DRAArticleCategory --|> DRAArticle : "links"
DRAArticleCategory --|> DRACategory : "links"
DRAUsersPlatform --|> EUserType : "classified as"
DRAArticle --|> EPublishStatus : "status"

note right of DRADataSource : Supports multiple data source types\nincluding databases, files, and PDFs\n\n**Encryption:**\nconnection_details uses ValueTransformer\nfor automatic encryption/decryption\nSupports legacy unencrypted data

note right of DRADashboard : Stores visualization data\nas JSONB configuration\nSupports chart definitions and layouts

note right of DRAUsersPlatform : Central user entity with\nrelationships to all major entities\n\n**Cascade Deletion:**\nDeleting user cascades to all owned entities

note left of DRAProject : **Cascade Behavior:**\nDeleting project cascades to:\n- All data sources (with cascade: remove)\n- All dashboards (with cascade: remove)\n- Data models via data source cascade\n- Physical tables dropped via processor

note right of DRAArticle : **Content Management:**\nSupports both HTML and Markdown\nSlug auto-generated from title\nPublish status controls visibility

@enduml
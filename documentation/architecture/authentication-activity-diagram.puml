@startuml Authentication_Activity_Diagram
title Data Research Analysis Platform - Authentication Workflow

|User|
start

:Navigate to registration page;

:Fill registration form;
:Enter email, first name, last name, password;

:Submit registration form;

|Backend|
:Receive registration request;
:Validate form data;

if (Email already exists?) then (yes)
    :Return error: Email already registered;
    |User|
    :Display error message;
    :Return to registration form;
else (no)
    :Hash password with bcrypt and salt;
    :Create new DRAUsersPlatform record;
    :Generate verification code;
    :Save verification code to database;
    :Send verification email;
    :Return success response;
    
    |User|
    :Display success message;
    :Show "Check your email" notification;
    
    :User checks email;
    :Click verification link;
    
    |Backend|
    :Receive verification request;
    :Validate verification code;
    
    if (Code valid and not expired?) then (yes)
        :Update email_verified_at timestamp;
        :Delete used verification code;
        :Return success response;
        
        |User|
        :Display "Email verified" message;
        :Redirect to login page;
        
        :Fill login form;
        :Enter email and password;
        :Submit login form;
        
        |Backend|
        :Receive login request;
        :Find user by email;
        
        if (User exists?) then (yes)
            if (Email verified?) then (yes)
                :Compare password with stored hash;
                
                if (Password matches?) then (yes)
                    :TokenProcessor.generateToken(payload);
                    note right: Payload contains:\n- user_id\n- email\n- user_type\n- iat (issued at)\n- exp (expiration)
                    :Set token expiration (from UtilityService);
                    :Return token and user data;
                    
                    |User|
                    :Store JWT token in localStorage;
                    :Update authentication state;
                    :Redirect to dashboard/projects;
                    
                    partition "Authenticated Session" {
                        :Access protected routes;
                        :Include JWT in API requests;
                        
                        |Backend|
                        :TokenProcessor.validateToken(token);
                        note right: Checks:\n- JWT signature\n- Expiration time\n- Token structure
                        
                        if (Token valid?) then (yes)
                            :TokenProcessor.getTokenDetails(token);
                            note right: Extract user context\nfrom token payload
                            :Attach user context to request;
                            :Process API request;
                            :Return requested data;
                        else (no)
                            :Return 401 Unauthorized;
                            
                            |User|
                            :Clear stored token;
                            :Redirect to login page;
                        endif
                    }
                    
                else (no)
                    :Return error: Invalid credentials;
                    |User|
                    :Display login error;
                endif
            else (no)
                :Return error: Email not verified;
                |User|
                :Display verification required message;
                :Option to resend verification email;
            endif
        else (no)
            :Return error: User not found;
            |User|
            :Display login error;
        endif
    else (no)
        :Return error: Invalid or expired code;
        |User|
        :Display verification failed message;
        :Option to resend verification email;
    endif
endif

|User|
if (Logout requested?) then (yes)
    :Clear JWT token from localStorage;
    :Clear authentication state;
    :Redirect to home page;
    stop
else (continue session)
    :Continue using application;
endif

'' Password Reset Flow

|User|
:Click "Forgot Password" on login page;
:Enter registered email;
:Submit forgot password form;

|Backend|
:Receive POST /auth/forgot-password;
:Find user by email;

if (User exists and email verified?) then (yes)
    :Generate secure reset code\n(crypto.randomBytes);
    :Save to dra_verification_codes with 15-min expiry;
    :Send password reset email\nwith reset link + code;

    :User clicks reset link;

    |Backend|
    :Receive reset request with code;
    :Validate code exists and not expired;

    if (Code valid?) then (yes)
        |User|
        :Show new password form;
        :Enter new password;
        :Submit POST /auth/reset-password\n{ code, newPassword };

        |Backend|
        :Hash new password with bcrypt;
        :Update dra_users_platform.password;
        :Delete used verification code;
        :Return success;

        |User|
        :Show "Password reset successfully";
        :Redirect to login page;
    else (no/expired)
        |User|
        :Show "Invalid or expired reset link";
        :Offer to resend reset email;
    endif
else (no)
    :Return generic "If account exists, email sent"\n(prevents email enumeration);
    |User|
    :Display generic message (no user info leaked);
endif

'' OAuth / Google SSO Flow

|User|
:Click "Sign in with Google" on login/register page;

|Backend|
:Receive GET /oauth/google/auth-url?service=sso;
:GoogleOAuthService.generateAuthUrl(profile+email scopes, state);
:Return authorizationUrl;

|User|
:Redirect to Google OAuth consent screen;
:User approves permissions;

|Backend|
:Receive GET /oauth/google/callback?code=AUTH_CODE;
:GoogleOAuthService.exchangeCodeForTokens(code);
:Fetch user profile from Google API\n(name, email, avatar);

if (User with email exists?) then (yes)
    :Link Google account to existing user;
    :TokenProcessor.generateToken(userPayload);
    |User|
    :Return JWT + redirect to dashboard;
else (no)
    :Auto-register new user\nwith Google profile data;
    :Set email_verified_at = NOW()\n(Google emails pre-verified);
    :TokenProcessor.generateToken(newUserPayload);
    |User|
    :Return JWT + redirect to dashboard (new user);
endif

floating note right
  **JWT Token Details:**
  Generated by TokenProcessor
  - User ID
  - Email
  - User type (ADMIN/NORMAL)
  - Expiration time
  - Issued at timestamp
  
  **Secret Source:**
  JWT_SECRET from UtilityService
end note

floating note left
  **Password Security:**
  Uses bcrypt with salt rounds
  configured via PASSWORD_SALT
  environment variable
  
  **UtilityService Methods:**
  - hashPassword(password)
  - comparePassword(password, hash)
end note

floating note right
  **Email Verification:**
  Verification code expires after
  configured time period
  Links contain UUID codes
  One-time use only
  
  **Middleware Integration:**
  - 02-load-data.global.ts
  - 03-validate-data.global.ts
end note

floating note left
  **Password Reset:**
  - Reset codes expire: 15 minutes
  - Single-use (deleted on use)
  - Rate limited: authLimiter 10 req/15min
  - No user enumeration in response

  **Google SSO:**
  - Scopes: profile, email
  - Auto-verified email (Google trust)
  - Links to existing account if email matches
  - OAuthSessionService (Redis) for token state
end note

@enduml
